<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>PIXI v4 Test</title>
  </head>
  <body>
    <script src="pixi.js" charset="utf-8"></script>
    <script type="text/javascript">

    /**
    *
    * @class WaveFilter
    * @extends AbstractFilter
    * @constructor
    */
    PIXI.WaveFilter = function()
    {

      var vertexSrc = [
        '#define GLSLIFY 1',

        'attribute vec2 aVertexPosition;',
        'attribute vec2 aTextureCoord;',
        'uniform mat3 projectionMatrix;',
        'uniform float waveHeight;',
        'uniform float waveFrequency;',
        'uniform float waveTime;',
        'uniform float wavePhase;',
        'uniform float UVSpeed;',
        'varying vec2 vTextureCoord;',
        'varying vec2 vCoord;',

        'void main(void){',
        '    gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);',
        '    vTextureCoord = aTextureCoord;',
        '    float time = waveFrequency * sin(wavePhase * (mod(waveTime - vTextureCoord.y, waveHeight)));',
        '    vCoord = vec2(vTextureCoord.x + time * UVSpeed, vTextureCoord.y);',
        '}'
      ].join('\n');

       var fragmentSrc = [
         '#define GLSLIFY 1',

         'precision mediump float;',
         'varying vec2 vTextureCoord;',

         'varying vec2 vCoord;',

         'uniform sampler2D uSampler;',

         'void main(void) {',
         '   gl_FragColor = texture2D(uSampler, vCoord);',
         '}'
       ].join('\n');

       PIXI.Filter.call( this, vertexSrc, fragmentSrc );

       this.padding = 512;

       this.uniforms.waveHeight = 0.5;
       this.uniforms.waveFrequency = 0.02;
       this.uniforms.waveTime = 0;
       this.uniforms.UVSpeed = 0.25;
       this.uniforms.wavePhase = 6.283185307179586;

    };

    PIXI.WaveFilter.prototype = Object.create( PIXI.Filter.prototype );
    PIXI.WaveFilter.prototype.constructor = PIXI.WaveFilter;

    Object.defineProperties(PIXI.WaveFilter.prototype, {
      waveHeight: {
        get: function() {
            return this.uniforms.waveHeight;
        },
        set: function(value) {
            this.uniforms.waveHeight = value;
        }
      },
      waveSpeed: {
        get: function() {
            return this.uniforms.UVSpeed;
        },
        set: function(value) {
            this.uniforms.UVSpeed = value;
        }
      },
      waveFrequency: {
        get: function() {
            return this.uniforms.waveFrequency;
        },
        set: function(value) {
            this.uniforms.waveFrequency = value;
        }
      },
      UVSpeed: {
        get: function() {
            return this.uniforms.UVSpeed;
        },
        set: function(value) {
            this.uniforms.UVSpeed = value;
        }
      },
      waveTime: {
        get: function() {
            return this.uniforms.waveTime;
        },
        set: function(value) {
            this.uniforms.waveTime = value;
        }
      },
      wavePhase: {
        get: function() {
            return this.uniforms.wavePhase;
        },
        set: function(value) {
            this.uniforms.wavePhase = (Math.PI / 180) * Number(value);
        }
      }
    });

    // You can use either `new PIXI.WebGLRenderer`, `new PIXI.CanvasRenderer`, or `PIXI.autoDetectRenderer`
    // which will try to choose the best renderer for the environment you are in.
    var renderer = new PIXI.WebGLRenderer(800, 600);

    // The renderer will create a canvas element for you that you can then insert into the DOM.
    document.body.appendChild(renderer.view);

    // You need to create a root container that will hold the scene you want to draw.
    var stage = new PIXI.Container();

    // Declare a global variable for our sprite so that the animate function can access it.
    var bunny = null;

    var waveFilter = new PIXI.WaveFilter();
    waveFilter.waveSpeed = 1.5;
    waveFilter.UVSpeed = 0.5;
    waveFilter.waveHeight = 1.0;
    waveFilter.waveFrequency = 0.5;

    // load the texture we need
    PIXI.loader.add('bunny', 'bunny.png').load(function (loader, resources) {
        // This creates a texture from a 'bunny.png' image.
        bunny = new PIXI.Sprite(resources.bunny.texture);

        // Setup the position and scale of the bunny
        bunny.position.x = 400;
        bunny.position.y = 300;

        bunny.scale.x = 2;
        bunny.scale.y = 2;

        bunny.filters = [waveFilter];

        // Add the bunny to the scene we are building.
        stage.addChild(bunny);

        // kick off the animation loop (defined below)
        animate();
    });

    function animate() {
        // start the timer for the next animation loop
        requestAnimationFrame(animate);

        // each frame we spin the bunny around a bit
        // bunny.rotation += 0.01;
        waveFilter.waveTime = Date.now() % 10000 / 10000;

        // this is the main render call that makes pixi draw your container and its children.
        renderer.render(stage);
    }

    </script>
  </body>
</html>
